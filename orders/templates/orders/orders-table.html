{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Замовлення{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-select-bs5/select.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-checkboxes-jquery/datatables.checkboxes.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-fixedcolumns-bs5/fixedcolumns.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/datatables-fixedheader-bs5/fixedheader.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/tagify/tagify.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/@form-validation/form-validation.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/bs-stepper/bs-stepper.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/dropzone/dropzone.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
  <script src="{% static 'vendor/libs/cleavejs/cleave.js' %}"></script>
  <script src="{% static 'vendor/libs/tagify/tagify.js' %}"></script>
  <script src="{% static 'vendor/libs/cleavejs/cleave-phone.js' %}"></script>
  <script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
  <script src="{% static 'vendor/libs/@form-validation/popular.js' %}"></script>
  <script src="{% static 'vendor/libs/@form-validation/bootstrap5.js' %}"></script>
  <script src="{% static 'vendor/libs/@form-validation/auto-focus.js' %}"></script>
  <script src="{% static 'vendor/libs/bs-stepper/bs-stepper.js' %}"></script>
  <script src="{% static 'vendor/libs/dropzone/dropzone.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
  {{ block.super }}
  <script>


    document.getElementById('add_color_button').addEventListener('click', function(event) {
      event.preventDefault();
      const container = document.getElementById('colors-container');
      const colorBlock = document.createElement('div');
      colorBlock.classList.add('row', 'g-3');

      colorBlock.innerHTML = `
        <div class="col-12 col-md-2">
            <div class="form-floating form-floating-outline">
                <input type="text" name="name" class="form-control" required>
                <label for="id_name">Колір</label>
            </div>
        </div>
        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <input type="number" name="height" class="form-control" required>
                <label for="id_height">Кут</label>
            </div>
        </div>
        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <input type="number" name="width" class="form-control" required>
                <label for="id_width">Точка</label>
            </div>
        </div>
        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <input type="number" name="center_point" class="form-control">
                <label for="id_center_point">lpi</label>
            </div>
        </div>
        <div class="col-12 col-md-2">
            <div class="form-floating form-floating-outline">
                <input type="number" name="height" class="form-control" required>
                <label for="id_height">Матеріал</label>
            </div>
        </div>
        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <input type="number" name="center_point" class="form-control">
                <label for="id_center_point">стр</label>
            </div>
        </div>
        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <input type="number" name="center_point" class="form-control">
                <label for="id_center_point">Ширина</label>
            </div>
        </div>
        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <input type="number" name="center_point" class="form-control">
                <label for="id_center_point">Висота</label>
            </div>
        </div>

        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <input type="number" name="center_point" class="form-control">
                <label for="id_center_point">к-сть</label>
            </div>
        </div>
        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <button type="button" class="btn btn-danger remove-block">X</button>
            </div>
        </div>
    `;

      const removeButton = colorBlock.querySelector('.remove-block');
      removeButton.addEventListener('click', function() {
        container.removeChild(colorBlock);
      });

      container.appendChild(colorBlock);
    });

    //добавления блока с фартуками
    document.getElementById('add_fartuk_button').addEventListener('click', function(event) {
      event.preventDefault(); // Остановить стандартное поведение кнопки

      // Контейнер для форм
      const container = document.getElementById('fartuk-forms-container');

      // Создать блок с формой
      const formBlock = document.createElement('div');
      formBlock.classList.add('row', 'g-3'); // Классы для оформления

      // HTML-шаблон с полями модели
      formBlock.innerHTML = `
        <div class="col-12 col-md-2">
            <div class="form-floating form-floating-outline">
                <input type="text" name="name" class="form-control" required>
                <label for="id_name">Назва</label>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="form-floating form-floating-outline">
                <input type="number" name="height" class="form-control" required>
                <label for="id_height">Висота</label>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="form-floating form-floating-outline">
                <input type="number" name="width" class="form-control" required>
                <label for="id_width">Ширина</label>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="form-floating form-floating-outline">
                <input type="number" name="center_point" class="form-control">
                <label for="id_center_point">Центр</label>
            </div>
        </div>
        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <button type="button" class="btn btn-danger remove-block">X</button>
            </div>
        </div>
    `;

      // Добавить обработчик удаления для кнопки "X"
      const removeButton = formBlock.querySelector('.remove-block');
      removeButton.addEventListener('click', function() {
        container.removeChild(formBlock);
      });

      // Добавить новый блок в контейнер
      container.appendChild(formBlock);
    });

    document.getElementById('add_damper_button').addEventListener('click', function(event) {

      event.preventDefault();
      const container = document.getElementById('damper-container');
      const damperBlock = document.createElement('div');
      damperBlock.classList.add('row', 'g-3');

      damperBlock.innerHTML = `
        <div class="col-12 col-md-3">
            <div class="form-floating form-floating-outline">
                <input type="text" name="name" class="form-control" required>
                <label for="id_name">Назва</label>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="form-floating form-floating-outline">
                <input type="number" name="height" class="form-control" required>
                <label for="id_height">Висота</label>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="form-floating form-floating-outline">
                <input type="number" name="width" class="form-control" required>
                <label for="id_width">Ширина</label>
            </div>
        </div>

        <div class="col-12 col-md-1">
            <div class="form-floating form-floating-outline">
                <button type="button" class="btn btn-danger remove-block">X</button>
            </div>
        </div>
    `;

      // Добавить обработчик удаления для кнопки "X"
      const removeButton = damperBlock.querySelector('.remove-block');
      removeButton.addEventListener('click', function() {
        container.removeChild(damperBlock);
      });

      // Добавить новый блок в контейнер
      container.appendChild(damperBlock);

    });


    (function() {

      // робота з завантаження файлів

      const allowedExtensions = {{ allowed_extensions|safe }};

      const previewTemplate = `<div class="dz-preview dz-file-preview">
    <div class="dz-details">
      <div class="dz-thumbnail">
        <img data-dz-thumbnail>
        <span class="dz-nopreview">Без превью</span>
        <div class="dz-success-mark"></div>
        <div class="dz-error-mark"></div>
        <div class="dz-error-message"><span data-dz-errormessage></span></div>
        <div class="progress">
          <div class="progress-bar progress-bar-primary" role="progressbar" aria-valuemin="0" aria-valuemax="100" data-dz-uploadprogress></div>
        </div>
      </div>
      <div class="dz-filename" data-dz-name></div>
      <div class="dz-size" data-dz-size></div>
    </div>
  </div>`;


      // Multiple Dropzone
      // --------------------------------------------------------------------
      const dropzoneMulti = document.querySelector('#dropzone-multi');
      if (dropzoneMulti) {
        const myDropzoneMulti = new Dropzone(dropzoneMulti, {
          url: "{% url 'orders:upload_files' %}",
          previewTemplate: previewTemplate,
          parallelUploads: 1,
          maxFilesize: 1024,
          addRemoveLinks: true,
          acceptedFiles: allowedExtensions.map(ext => '.' + ext).join(','),
          autoProcessQueue: true,
          headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }

        });

        // Добавьте обработчики для успешной загрузки или ошибок
        myDropzoneMulti.on('success', function(file, response) {
          console.log('Серверный ответ:', response);
          console.log('Файл загружен:', response.message);
        });
        myDropzoneMulti.on('error', function(file, response) {
          console.error('Ошибка загрузки файла:', response.error);
        });
      }
    })();

  </script>
  <script>

    // заполнение и работа с таблицей
    $(function() {
      let dt_select_table = $('.dt-select-table');
      if (dt_select_table.length) {
        var dt_select = dt_select_table.DataTable({
          ajax: "{% url 'orders:orders_data' %}",
          columns: [
            { data: 'id' },
            { data: 'id' },
            { data: 'start_date' },
            { data: 'status' },
            { data: 'client' },
            { data: 'printing_company' },
            { data: 'name' },
            { data: 'technology' },
            { data: 'order_material' },
            { data: 'ruling' },
            { data: 'slices_count' },
            { data: 'forms_area' },
            { data: 'fartuks_area' },
            { data: 'fartuk' },
            { data: 'fartuks' },
            { data: 'pay' },
            { data: 'check' },
            { data: 'shipping_date_planed' },
            { data: 'shipping_date_departure' },
            { data: 'delivery' },
            { data: 'contact' },
            { data: 'contact' }

          ],
          lengthMenu: [[100, 200, 500], [100, 200, 500]],
          columnDefs: [
            {
              // For Checkboxes
              targets: 0,
              searchable: false,
              orderable: false,
              render: function() {
                return '<input type="checkbox" class="dt-checkboxes form-check-input">';
              },
              checkboxes: {
                {#selectRow: true,#}
                selectAllRender: '<input type="checkbox" class="form-check-input">'
              }
            }

          ],
          order: [[1, 'desc']],
          dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6 d-flex justify-content-center justify-content-md-end"f>><"table-responsive"t><"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
          language: {
            paginate: {
              next: '<i class="ri-arrow-right-s-line"></i>',
              previous: '<i class="ri-arrow-left-s-line"></i>'
            }
          },
          select: {
            // Select style
            style: 'multi'
          },
          processing: true,
          serverSide: true,
          scrollY: '65vh',
          {#search: {#}
          {#  return: true#}
          {# },#}
          scrollX: true
        });


        // Добавление события на двойной щелчок
        dt_select_table.on('dblclick', 'tr', function() {
          var rowData = dt_select.row(this).data(); // Получить данные строки
          if (rowData) {
            // Добавьте любое действие, например, открытие модального окна
            get_order_info(rowData.id);
          }
        });
      }
    });


  </script>

  <script>
    {#function add_data_in_order_form(order_id) {#}
    {#  let order = get_order_info(order_id);#}
    {##}
    {#}#}

    function get_order_info(order_id) {
      const url = `{% url "orders:get_order_info" %}?order_id=${order_id}`;

      // Выполнение GET-запроса
      fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken') // Если CSRF токен нужен
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json(); // Преобразуем ответ в JSON
        })
        .then(data => {
          // Проверяем статус ответа
          if (data.status === 'success') {
            console.log('Заказ:', data.order);
            console.log('Демперы:', data.dampers);
            console.log('Фартуки:', data.fartuks);
            console.log('Слайсы:', data.slices);
            console.log('Редактируемость:', data.editable);
          } else {
            console.error('Ошибка:', data.message);
          }
        })
        .catch(error => {
          console.error('Произошла ошибка при запросе:', error);
        });
    }


    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Проверяем, соответствует ли имя куки
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }


  </script>
{% endblock page_js %}

{% block content %}


  <div class="card">
    <h5 class="card-header text-center text-md-start pb-md-0">Таблиця замовлень</h5>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createOrder"> Додати
      замовлення
    </button>
    <div class="card-datatable dataTable_select text-nowrap">
      <table class="dt-select-table table table-bordered">
        <thead>
        <tr>
          <th></th>

          <th>id</th>
          <th>дата запуску</th>
          <th>статус</th>
          <th>Замовник</th>
          <th>Друкарська компанія</th>
          <th>назва замовлення</th>
          <th>технологія</th>
          <th>матеріал</th>
          <th>лініатура</th>
          <th>кількість форм</th>
          <th>площа замовлення</th>
          <th>площа фартуків</th>
          <th>тип фартуків</th>
          <th>розміри фартуків</th>
          <th>оплата</th>
          <th>рахунок</th>
          <th>плануєма відправка</th>
          <th>фактична відправка</th>
          <th>адреса доставки</th>
          <th>контакт доставки</th>
          <th>брак</th>
        </tr>
        </thead>
      </table>
    </div>
  </div>


  <div class="modal fade" id="createOrder" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-simple">
      <div class="modal-content">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="modal-body p-0">
          <div class="text-center mb-6">
            <h4 class="mb-2">Створення замовлення</h4>
          </div>
          <div class="col-12">
            <div class="card">
              <h5 class="card-header">Завантажте файли</h5>
              <div class="card-body">
                <form action="{% url 'orders:upload_files' %}" method="post" enctype="multipart/form-data"
                      class="dropzone needsclick" id="dropzone-multi">
                  {% csrf_token %}
                  <div class="dz-message needsclick">
                    Перетягніть файли сюди або натисніть, щоб завантажити
                  </div>
                  <div class="fallback">
                    <input name="file" type="file" />
                  </div>
                </form>
              </div>
            </div>
          </div>
          <br>

          <form id="createOrderForm" class="row g-5" onsubmit="return false">
            {% csrf_token %}
            <div class="col-12 col-md-6">
              <label class="switch">
                <input type="checkbox" class="switch-input">
                <span class="switch-toggle-slider">
              <span class="switch-on"></span>
              <span class="switch-off"></span>
            </span>
                <span class="switch-label">Терміновий</span>
              </label>
            </div>
            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.engraver }}
                {{ create_order_form.engraver.label_tag }}
              </div>
            </div>

            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.work_file }}
                {{ create_order_form.work_file.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.name }}
                {{ create_order_form.name.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.company_client }}
                {{ create_order_form.company_client.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.printing_company }}
                {{ create_order_form.printing_company.label_tag }}
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.preset }}
                {{ create_order_form.preset.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                <small class="text-light fw-medium d-block">Друк</small>
                {% for value, label in create_order_form.revert_print.field.choices %}
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="{{ create_order_form.revert_print.name }}"
                           id="inlineRadio{{ forloop.counter }}" value="{{ value }}">
                    <label class="form-check-label" for="inlineRadio{{ forloop.counter }}">{{ label }}</label>
                  </div>
                {% endfor %}

              </div>
            </div>
            <div class="col-12 col-md-3">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.compression }}
                {{ create_order_form.compression.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-3">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.compression_value }}
                {{ create_order_form.compression_value.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.technology }}
                {{ create_order_form.technology.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.angle_set }}
                {{ create_order_form.angle_set.label_tag }}
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.color_library }}
                {{ create_order_form.color_library.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-2">
              <p>параметри для кольорів</p>
            </div>
            <div class="col-12 col-md-2">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.raster_dot_default }}
                {{ create_order_form.raster_dot_default.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-2">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.ruling_default }}
                {{ create_order_form.ruling_default.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-2">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.materials_default }}
                {{ create_order_form.materials_default.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-2">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.height_default }}
                {{ create_order_form.height_default.label_tag }}
              </div>
            </div>
            <div class="col-12 col-md-2">
              <div class="form-floating form-floating-outline">
                {{ create_order_form.width_default }}
                {{ create_order_form.width_default.label_tag }}
              </div>
            </div>
            <div id="colors-container" class="row"></div>
            <div class="col-12 text-center d-flex flex-wrap justify-content-center gap-4 row-gap-4">
              <button class="btn btn-primary" id="add_color_button">додати колір</button>
            </div>

            <div id="fartuk-forms-container" class="row"></div>
            <div class="col-12 text-center d-flex flex-wrap justify-content-center gap-4 row-gap-4">
              <button class="btn btn-primary" id="add_fartuk_button">додати фартук</button>
            </div>

            <div id="damper-container" class="row"></div>

            <div class="col-12 text-center d-flex flex-wrap justify-content-center gap-4 row-gap-4">
              <button class="btn btn-primary" id="add_damper_button">додати демпер</button>
            </div>

            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                {{ delivery_form.area }}
                {{ delivery_form.area.label_tag }}
              </div>
            </div>

            <div class="col-12 col-md-6">
              <div class="form-floating form-floating-outline">
                {{ delivery_form.settlement }}
                {{ delivery_form.settlement.label_tag }}
              </div>
            </div>

            <div class="col-12 col-md-4">
              <div class="form-floating form-floating-outline">
                {{ delivery_form.delivery_type }}
                {{ delivery_form.delivery_type.label_tag }}
              </div>
            </div>


            <div class="col-12 col-md-4">
              <div class="form-floating form-floating-outline">
                <small class="text-light fw-medium d-block">Вид доставки</small>
                {% for value, label in delivery_form.np_type_field.field.choices %}
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="{{ delivery_form.np_type_field.name }}"
                           id="np_delivery_tupe_{{ forloop.counter }}" value="{{ value }}">
                    <label class="form-check-label" for="np_delivery_tupe_{{ forloop.counter }}">{{ label }}</label>
                  </div>
                {% endfor %}

              </div>
            </div>

            <div class="col-12 col-md-4">
              <div class="form-floating form-floating-outline">
                {{ delivery_form.post_office_ref }}
                {{ delivery_form.post_office_ref.label_tag }}
              </div>
            </div>

            <div class="col-12 col-md-8">
              <div class="form-floating form-floating-outline">
                {{ delivery_form.street }}
                {{ delivery_form.street.label_tag }}
              </div>
            </div>

            <div class="col-12 col-md-4">
              <div class="form-floating form-floating-outline">
                {{ delivery_form.build }}
                {{ delivery_form.build.label_tag }}
              </div>
            </div>


            <div class="col-12 ">
              <div class="form-floating form-floating-outline">
                {{ delivery_form.description }}
                {{ delivery_form.description.label_tag }}
              </div>
            </div>


            <div class="col-12 text-center d-flex flex-wrap justify-content-center gap-4 row-gap-4">
              <button type="submit" class="btn btn-primary">Додати замовлення</button>
              <button type="reset" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Close">Очистити
                форму
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>



{% endblock content %}

